---
- name: Prepare GUID environment variable across all hosts
  hosts: all
  tasks:
    - name: All GUID env variable
      shell: export GUID=`hostname | cut -d"." -f2`; echo "export GUID=$GUID" >> $HOME/.bashrc

- name: Verify Installation and Configuration of Docker
  hosts: nodes
  tasks:
    - name: docker restart
      shell: systemctl restart docker

- name: Verify NFS Shared Volumes on Hosts
  hosts: nfs
  tasks:
    - name: nfs is available
      shell: ansible nfs -m shell -a"exportfs"

- name: Install packages and config auth
  hosts: localhost
  tasks:
    - name: required packages are present
      yum:
        name:
          - openshift-ansible 
          - atomic-openshift-clients
        state: present

- name: Generate Inventory Hosts File
  hosts: localhost
  tasks:
    - name: Generate Inventory script
      script: /root/ocp_advanced_deployment_homework/scripts/generate_inventory.sh

- name: Execute the openshift-ansible prerequisites
  import_playbook: /usr/share/ansible/openshift-ansible/playbooks/prerequisites.yml

- name: Execute the openshift-ansible Deployer
  import_playbook: /usr/share/ansible/openshift-ansible/playbooks/deploy_cluster.yml

- name: Verify OpenShift Cluster
  hosts: localhost
  tasks:
    - name: copy the .kube directory from master1 to your bastion
      shell: ansible masters[0] -b -m fetch -a "src=/root/.kube/config dest=/root/.kube/config flat=yes"

- name: Post installation configuration
  hosts: localhost
  tasks:
    - name: make sure you are system:admin
      shell: oc whoami | grep system:admin

- name: Install  nfs package
  hosts: nfs
  tasks:
    - name: required packages are present
      yum:
        name:
          - nfs-utils
        state: present

- name: Create PVs for Users
  hosts: nfs
  tasks:
    - name: Create pV
      script: /root/ocp_advanced_deployment_homework/scripts/create_pvs.sh
    - name: Restarting NFS Server...
      shell: systemctl restart nfs-server
